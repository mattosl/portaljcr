<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">	
<ui:component xmlns="http://www.w3.org/1999/xhtml"
	xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
	xmlns:h="http://xmlns.jcp.org/jsf/html"
	xmlns:f="http://xmlns.jcp.org/jsf/core"
	xmlns:p="http://primefaces.org/ui"
	xmlns:c="http://java.sun.com/jsp/jstl/core"
	xmlns:jsf="http://xmlns.jcp.org/jsf" >
	
	<ui:composition template="/pages/templates/layout.xhtml">
		<ui:param name="activeSubmenu" value="exibirChamado"/>
    	<ui:param name="activeMenu" value="suporte"/>
    	
    	<ui:define name="pageTitle"><i class="fa fa-plus-square fa-1x cor-padrao"></i> Chamado Nº #{chamadoController.chamado.id}</ui:define>
    	<ui:define name="breadcrumb">
			<li><i class="fa fa-wrench"></i> Suporte TI</li>
	    	<li class="active"><i class="fa fa-plus-square"></i> Exibir Chamado</li>
		</ui:define>
		<ui:define name="body">
			<div class="page-content-central ui-fluid">
				<h:form id="chamadoForm" acceptcharset="ISO-8859-1" lang="pt_BR">
					<f:validateBean disabled="true" for="@form">
						
						<div class="nav-tabs-custom">
							<ul class="nav nav-tabs">
								<li id="abaChamado" class="active"><a href="#infoChamado" data-toggle="tab"><i class="fa fa-newspaper-o"></i>&nbsp;Informações do Chamado</a></li>
								<li id="abaAcompanhamento" jsf:rendered="#{chamadoController.chamado.usuarioResponsavel != null}"><a href="#acompanhamento" data-toggle="tab"><i class="fa fa-comments-o"></i>&nbsp;Acompanhamento</a></li>
								<li id="abaAnexos" jsf:rendered="#{chamadoController.chamado.usuarioResponsavel != null}"><a href="#anexos" data-toggle="tab"><i class="fa fa-file-text-o"></i>&nbsp;Anexos</a></li>
							</ul>
							<div class="tab-content">
								<div class="active tab-pane" id="infoChamado">
									<p:panel toggleable="false" id="painelChamado" style="border: 0px;">
										<div class="form-horizontal">
											<div class="box-body">
												<div class="form-group">
													<div class="col-sm-2 col-md-2 control-label">
														<label for="solicitante">Solicitante:</label>
													</div>
				
													<div class="col-sm-4 col-md-4">
														<p:outputLabel id="solicitante" value="#{chamadoController.chamado.usuarioSolicitante.nome}" styleClass="control-label font-normal" />
													</div>
													
													<div class="col-sm-2 col-md-2 control-label">
														<label for="responsavel">Responsável:</label>
													</div>
				
													<div class="col-sm-4 col-md-4">
														<p:outputLabel id="responsavel" value="#{chamadoController.chamado.usuarioResponsavel.nome}" styleClass="control-label font-normal" />
													</div>
												</div>
												<div class="form-group">
													<div class="col-sm-2 col-md-2 control-label">
														<label for="situacao">Situação:</label>
													</div>
				
													<div class="col-sm-4 col-md-4">
														<p:outputLabel id="situacao" value="#{chamadoController.chamado.situacao.descricao}" styleClass="control-label font-normal" />
													</div>
													
													<div class="col-sm-2 col-md-2 control-label">
														<label for="prioridade">Prioridade:</label>
													</div>
				
													<div class="col-sm-4 col-md-4">
														<p:outputLabel id="prioridade" value="#{chamadoController.chamado.prioridade.descricao}" styleClass="control-label font-normal" />
													</div>
												</div>
												<div class="form-group">
													<div class="col-sm-2 col-md-2 control-label">
														<label for="categoria">Categoria:</label>
													</div>
				
													<div class="col-sm-10 col-md-10">
														<p:outputLabel id="categoria" value="#{chamadoController.chamado.categoria} / #{chamadoController.chamado.subcategoria}" styleClass="control-label font-normal" />
													</div>
												</div>
												<div class="form-group">
													<div class="col-sm-2 col-md-2 control-label">
														<label for="titulo">Título:</label>
													</div>
				
													<div class="col-sm-10 col-md-10">
														<p:outputLabel id="titulo" value="#{chamadoController.chamado.titulo}" styleClass="control-label font-normal" />
													</div>
												</div>
												<div class="form-group">
													<div class="col-sm-2 col-md-2 control-label">
														<label for="descricao">Descrição:</label>
													</div>
				
													<div class="col-sm-10 col-md-10">
														<h:inputTextarea id="descricao" value="#{chamadoController.chamado.descricao}" styleClass="form-control" rows="5" readonly="true"/>
													</div>
												</div>
											</div>
											<div class="box-footer">
												<div class="col-sm-3 col-md-3" >
													<p:commandButton
														styleClass="btn btn-default"
														icon="fa fa-arrow-left"
														value="Voltar"
														id="btn_voltar"
														process="@this"
														immediate="true"
														action="#{chamadoController.voltar()}"
														ajax="false" />
												</div>
												<div class="col-sm-3 col-md-3" >
													<p:commandButton
														styleClass="btn btn-default"
														icon="fa fa-pencil-square-o"
														value="Atribuir para mim"
														id="btn_atribuir"
														process="@this"
														update="@form"
														action="#{chamadoController.atribuir()}"
														ajax="true" rendered="#{chamadoController.chamado.usuarioResponsavel == null}"
														oncomplete="window.scrollTo(0,0);" />
													<p:commandButton
														styleClass="btn btn-default"
														icon="fa fa-pencil-square"
														value="Solucionar Chamado"
														id="btn_adicionar_solucao"
														process="@this"
														update="@form"
														action="#{chamadoController.atribuir()}"
														ajax="true" rendered="#{chamadoController.chamado.usuarioResponsavel != null}" />
												</div>
											</div>
										</div>
									</p:panel>
              					</div>
              					<div class="tab-pane" id="acompanhamento" >
									<p:panel toggleable="false" id="painelChat" style="border: 0px;" rendered="#{chamadoController.chamado.usuarioResponsavel != null}">
										<div class="form-horizontal">
											<div class="box-body direct-chat-danger" style="background-color: #f9f9f9;border-radius: 5px;" jsf:rendered="#{chamadoController.chamado.mensagens.size() > 0}">
												 <div id="messengers" class="direct-chat-messages">
												 	<ui:repeat var="mensagem" value="#{chamadoController.chamado.mensagensList}" varStatus="status">
												 		<p:outputPanel rendered="#{mensagem.usuario.id ne usuario.id}">
												 			<div class="direct-chat-msg">
														 		<div class="direct-chat-info clearfix">
														 			<span class="direct-chat-name pull-left">#{mensagem.usuario.nome}</span>
																	<span class="direct-chat-timestamp pull-right">#{mensagem.dataFormatada}</span>
														 		</div>
														 		<div class="direct-chat-text pull-left">
																	#{mensagem.mensagem}
															  	</div>
														 	</div>
												 		</p:outputPanel>
												 		<p:outputPanel rendered="#{mensagem.usuario.id eq usuario.id}">
												 			<div class="direct-chat-msg right">
														 		<div class="direct-chat-info clearfix">
														 			<span class="direct-chat-name pull-right">#{mensagem.usuario.nome}</span>
																	<span class="direct-chat-timestamp pull-left">#{mensagem.dataFormatada}</span>
														 		</div>
														 		<div class="direct-chat-text pull-right">
																	#{mensagem.mensagem}
															  	</div>
														 	</div>
												 		</p:outputPanel>
												 	</ui:repeat>
												 </div>
											</div>
											<div class="box-body" jsf:rendered="#{chamadoController.chamado.mensagens.size() == 0}" >
												<div class="form-group" style="text-align:center;">
													<label>Nenhuma mensagem enviada.</label>
												</div>
											</div>
											<div class="box-footer">
												<div class="col-sm-10 col-md-10">
													<h:inputText id="nome" value="#{chamadoController.mensagem}" maxlength="500" styleClass="form-control" />
													<p:watermark value="Escreva uma mensagem..." for="nome" />
												</div>
												<div class="col-sm-2 col-md-2">
													<p:commandButton
														styleClass="btn btn-default"
														icon="fa fa-arrow-right"
														value="Enviar"
														id="btn_enviar"
														process="@form:painelChat"
														update="@form:painelChat"
														action="#{chamadoController.enviarMensagem()}"
														oncomplete="scrollDown();"
														ajax="true" />
												</div>
											</div>
										</div>
									</p:panel>
              					</div>
              					<div class="tab-pane" id="anexos">
									<p:panel toggleable="false" id="painelAnexos" style="border: 0px;">
										<p:dataTable var="anexo" 
											value="#{chamadoController.chamado.anexos}" 
											tableStyle="table-layout: auto; word-break: keep-all;"
											emptyMessage="Nenhum anexo cadastrado neste chamado." >
											
										    <p:column headerText="Nome do Arquivo">
										        <h:outputText value="#{anexo.nome}" />
										    </p:column>
										    
											<p:column headerText="Download" style="text-align: center;">
												<p:commandLink ajax="true" process="@this" update="@form:painelAnexos" onclick="PrimeFaces.monitorDownload(start, stop);">
													<h:outputText value="" title="Download" styleClass="fa fa-download" />
													<p:fileDownload value="#{chamadoController.download(anexo)}" />
												</p:commandLink>
											</p:column>
										</p:dataTable>
									</p:panel>
								</div>
              				</div>
						</div>
					</f:validateBean>
				</h:form>
				<script type="text/javascript">

					$(document).ready(function(){
						$("#abaAcompanhamento").on("click", function(){
							setTimeout(function() {
								scrollDown();
							}, 0)
						});
					});

					function scrollDown(){
						var objDiv = document.getElementById("messengers");
						objDiv.scrollTop = objDiv.scrollHeight;
					}
					
					function start() {
					    PF('statusDialog').show();
					}
					 
					function stop() {
					    PF('statusDialog').hide();
					}
				</script>
			</div>
		</ui:define>
	</ui:composition>
</ui:component>